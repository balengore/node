<html>
<head>
<script src="http://static.firebase.com/v0/firebase.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
<script>
var NflTracker = {
  init: function() {
    //NflTracker.render_games();
  }, 

  bind_events: function() {
    var fb_nfl_games = new Firebase('http://gamma.firebase.com/balen/games/nfl/');
    fb_nfl_games.on('child_changed', function(data){
      console.log(data.val());
      //TODO instead of rendering all games whenever 1 changes, only re-render the one that changed, and use an opacity animation to hightlight it
      NflTracker.render_games();
    });

    fb_nfl_games.on('child_added', function(data){
      console.log(data.val());
      if ($("#game-" + data.val().eid).length == 0) {
        var game_table = $("#game_table");
        NflTracker.add_game(game_table, data.val());
      }
    });

  },

  render_games: function() {
    var fb_nfl_games = new Firebase('http://gamma.firebase.com/balen/games/nfl/');
    console.log("render games");
    var game_table = $("#game_table");
    game_table.empty();
    fb_nfl_games.once('value', function(data){
      $.each(data.val(), function(index, game) {
        NflTracker.add_game(game_table, game);
        console.log(game);
      });
    });

  },

  add_game: function(parent_element, game) {
    console.log("add_game");
    console.log(parent_element);
    if ($("ul#week" + game.week).length == 0) {
      console.log("adding ul for week: " + game.week);
      parent_element.append("<div style='height:75px'><ul id='week" + game.week + "' ></ul></div>");
    }
    $("ul#week" + game.week).append(NflTracker.make_game_html(game));
  },

  make_game_html: function(game) {
    return "<li id=game-" + game.eid + ">" + 
    "<p>" + game.time + " " + game.quarter + "</p>" + 
    "<p><span>" + game.home_team + " " + game.home_score + "</span></p>" + 
    "<p><span>" + game.away_team + " " + game.away_score +"</span></p></li>"
  },

  parse_game: function(xml) {
    var data = {};

    data["eid"] = xml.attr("eid");
    data["gsis"] = xml.attr("gsis");
    data["day"] = xml.attr("d");
    data["time"] = xml.attr("t");
    data["quarter"] = xml.attr("q");
    data["home_team"] = xml.attr("h");
    data["home_nickname"] = xml.attr("hnn");
    data["home_score"] = xml.attr("hs");
    data["away_team"] = xml.attr("v");
    data["away_nickname"] = xml.attr("vnn");
    data["away_score"] = xml.attr("vs");
    data["rz"] = xml.attr("rz");
    data["ga"] = xml.attr("ga");
    data["game_type"] = xml.attr("gt");
    return data;
  },

  save_games: function(all_xml) {
    var game_data = $($.parseXML(all_xml));
    var fb_nfl_games = new Firebase('http://gamma.firebase.com/balen/games/nfl/');
    game_data.find("g").each(function(index, game){
      var $game = $(game);
      var id = $game.attr("eid");
      var fb_game = fb_nfl_games.child(id);
      fb_game.set(NflTracker.parse_game($game));
    });
  },

}

$(document).ready(function() {
  NflTracker.bind_events();
  NflTracker.init();
});
</script>
<style>
#game_table {
  overflow-x: hidden;
}
#game_table ul
{
  margin: 0;
  padding: 0;
  list-style-type: none;
}
#game_table ul li { 
  display: inline;
  float: left; 
  border-radius: 4px;
  border: 1px solid gray;
  margin: 2px;
}

#game_table ul li p{ 
  margin: 2px;
}

</style>
</head>
<body>
<div id="header"></div>
<div id="game_table">
</div>
<div id="footer"></div>
</body>
</html>